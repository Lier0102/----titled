from flask import Flask, render_template, request, jsonify
import requests
import re
from datetime import datetime

app = Flask(__name__)

# ê°„ë‹¨í•œ ê°ì • ë¶„ì„ (í‚¤ì›Œë“œ ê¸°ë°˜)
EMOTION_KEYWORDS = {
    'happy': ['í–‰ë³µ', 'ê¸°ì˜', 'ì¢‹ì•„', 'ì¦ê±°', 'ì‹ ë‚˜', 'ì›ƒ', 'ë§Œì¡±', 'ìµœê³ ', 'ì™„ë²½', 'ì‚¬ë‘'],
    'sad': ['ìŠ¬í”„', 'ìš°ìš¸', 'í˜ë“¤', 'ê´´ë¡œ', 'ì•„í”„', 'ëˆˆë¬¼', 'ì™¸ë¡œ', 'ì ˆë§', 'ë‹µë‹µ', 'ì†ìƒ'],
    'angry': ['í™”ë‚˜', 'ì§œì¦', 'ë¶„ë…¸', 'ì—´ë°›', 'ë¹¡ì³', 'ë¯¸ì¹˜', 'ì‹«ì–´', 'ìŠ¤íŠ¸ë ˆìŠ¤', 'ì–µìš¸', 'ë‹µë‹µ'],
    'anxious': ['ë¶ˆì•ˆ', 'ê±±ì •', 'ë‘ë ¤', 'ë¬´ì„œ', 'ê¸´ì¥', 'ë–¨ë ¤', 'ì´ˆì¡°', 'ì¡°ê¸‰', 'ê·¼ì‹¬', 'ì—¼ë ¤'],
    'tired': ['í”¼ê³¤', 'ì§€ì³', 'í˜ì—†', 'ì¡¸ë ¤', 'ë‚˜ë¥¸', 'ë¬´ê¸°ë ¥', 'ê·€ì°®', 'ë²ˆì•„ì›ƒ', 'íƒˆì§„', 'ì§€ì¹¨'],
    'excited': ['ì„¤ë ˆ', 'ê¸°ëŒ€', 'í¥ë¯¸', 'ì‹ ê¸°', 'ì¬ë¯¸', 'í™œê¸°', 'ì—ë„ˆì§€', 'ì—´ì •', 'ë™ê¸°', 'ì˜ìš•']
}

def analyze_emotion(text):
    """ê°„ë‹¨í•œ í‚¤ì›Œë“œ ê¸°ë°˜ ê°ì • ë¶„ì„"""
    text = text.lower()
    emotion_scores = {}
    
    for emotion, keywords in EMOTION_KEYWORDS.items():
        score = 0
        for keyword in keywords:
            if keyword in text:
                score += 1
        emotion_scores[emotion] = score
    
    if max(emotion_scores.values()) == 0:
        return 'neutral'
    
    return max(emotion_scores, key=emotion_scores.get)

def get_weather_data():
    """ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (OpenWeatherMap API ì‹œë®¬ë ˆì´ì…˜)"""
    # ì‹¤ì œ API í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ ë”ë¯¸ ë°ì´í„° ì‚¬ìš©
    # ì‹¤ì œ êµ¬í˜„ì‹œ: api_key = "YOUR_API_KEY"
    # url = f"http://api.openweathermap.org/data/2.5/weather?q=Seoul&appid={api_key}&units=metric&lang=kr"
    
    # ë”ë¯¸ ë‚ ì”¨ ë°ì´í„°
    import random
    weather_conditions = ['ë§‘ìŒ', 'íë¦¼', 'ë¹„', 'ëˆˆ', 'ì•ˆê°œ']
    temperatures = list(range(-5, 35))
    
    return {
        'condition': random.choice(weather_conditions),
        'temperature': random.choice(temperatures),
        'humidity': random.randint(30, 90),
        'city': 'ì„œìš¸'
    }

def generate_response(emotion, weather):
    """ê°ì •ê³¼ ë‚ ì”¨ì— ë”°ë¥¸ ë§ì¶¤í˜• ì‘ë‹µ ìƒì„±"""
    responses = {
        'happy': {
            'ë§‘ìŒ': f"ê¸°ë¶„ì´ ì¢‹ìœ¼ì‹œêµ°ìš”! ì˜¤ëŠ˜ ë‚ ì”¨ë„ ë§‘ê³  ({weather['temperature']}Â°C) ì™„ë²½í•œ í•˜ë£¨ë„¤ìš”! ğŸŒ ì‚°ì±…ì´ë‚˜ ì•¼ì™¸í™œë™ ì–´ë– ì„¸ìš”?",
            'íë¦¼': f"ê¸°ë¶„ì€ ì¢‹ì§€ë§Œ ë‚ ì”¨ê°€ íë¦¬ë„¤ìš” ({weather['temperature']}Â°C). ê·¸ë˜ë„ ì¢‹ì€ ê¸°ë¶„ìœ¼ë¡œ ì‹¤ë‚´ì—ì„œ ì¦ê±°ìš´ ì‹œê°„ ë³´ë‚´ì„¸ìš”! â˜ï¸",
            'ë¹„': f"ê¸°ë¶„ì´ ì¢‹ìœ¼ì‹œë„¤ìš”! ë¹„ê°€ ì˜¤ì§€ë§Œ ({weather['temperature']}Â°C) ë¹—ì†Œë¦¬ ë“¤ìœ¼ë©° ë”°ëœ»í•œ ì°¨ í•œ ì” ì–´ë– ì„¸ìš”? â˜”",
            'ëˆˆ': f"ì¢‹ì€ ê¸°ë¶„ì— ëˆˆê¹Œì§€! ({weather['temperature']}Â°C) ë¡œë§¨í‹±í•œ ì„¤ê²½ì„ ì¦ê²¨ë³´ì„¸ìš” â„ï¸",
            'ì•ˆê°œ': f"ê¸°ë¶„ì´ ì¢‹ìœ¼ì‹œêµ°ìš”! ì•ˆê°œ ë‚€ ë‚ ì”¨ì§€ë§Œ ({weather['temperature']}Â°C) ì‹ ë¹„ë¡œìš´ ë¶„ìœ„ê¸°ë¥¼ ë§Œë½í•´ë³´ì„¸ìš” ğŸŒ«ï¸"
        },
        'sad': {
            'ë§‘ìŒ': f"í˜ë“œì‹œê² ì§€ë§Œ ë°–ì€ ë§‘ê³  ë”°ëœ»í•´ìš” ({weather['temperature']}Â°C). í–‡ë³•ì„ ì¬ë©° ì ê¹ ì‚°ì±…í•´ë³´ì„¸ìš”. ê¸°ë¶„ì´ ë‚˜ì•„ì§ˆ ê±°ì˜ˆìš” ğŸŒ",
            'íë¦¼': f"ë§ˆìŒë„ ë‚ ì”¨ë„ íë¦¬ë„¤ìš” ({weather['temperature']}Â°C). ì¢‹ì•„í•˜ëŠ” ìŒì•… ë“¤ìœ¼ë©° ë”°ëœ»í•œ ìŒë£Œ í•œ ì” ì–´ë– ì„¸ìš”? â˜ï¸",
            'ë¹„': f"ë§ˆìŒì´ í˜ë“œì‹œêµ°ìš”. ë¹„ ì˜¤ëŠ” ë‚  ({weather['temperature']}Â°C) ì§‘ì—ì„œ í‘¹ ì‰¬ì‹œê³ , ì¢‹ì€ ì˜í™”ë‚˜ ì±…ìœ¼ë¡œ ìœ„ë¡œë°›ìœ¼ì„¸ìš” â˜”",
            'ëˆˆ': f"í˜ë“  ë§ˆìŒì— ëˆˆê¹Œì§€ ì˜¤ë„¤ìš” ({weather['temperature']}Â°C). í•˜ì§€ë§Œ ìƒˆí•˜ì–€ ëˆˆì²˜ëŸ¼ ìƒˆë¡œìš´ ì‹œì‘ì´ ì˜¬ ê±°ì˜ˆìš” â„ï¸",
            'ì•ˆê°œ': f"ë§ˆìŒì´ ì•ˆê°œì²˜ëŸ¼ ë‹µë‹µí•˜ì‹œê² ì–´ìš” ({weather['temperature']}Â°C). ê³§ ì•ˆê°œê°€ ê±·íˆë“¯ ë§ˆìŒë„ ë§‘ì•„ì§ˆ ê±°ì˜ˆìš” ğŸŒ«ï¸"
        },
        'angry': {
            'ë§‘ìŒ': f"í™”ê°€ ë‚˜ì‹œëŠ”êµ°ìš”. ë§‘ì€ ë‚ ì”¨ ({weather['temperature']}Â°C)ë¥¼ í™œìš©í•´ ìš´ë™ìœ¼ë¡œ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í’€ì–´ë³´ì„¸ìš”! ğŸŒ",
            'íë¦¼': f"ê¸°ë¶„ì´ ì¢‹ì§€ ì•Šìœ¼ì‹œêµ°ìš”. íë¦° ë‚ ì”¨ ({weather['temperature']}Â°C)ì²˜ëŸ¼ ë§ˆìŒë„ ë¬´ê±°ìš°ì‹œê² ì–´ìš”. ê¹Šê²Œ ìˆ¨ì‰¬ë©° ì§„ì •í•´ë³´ì„¸ìš” â˜ï¸",
            'ë¹„': f"í™”ë‚˜ëŠ” ë§ˆìŒì— ë¹„ê¹Œì§€ ì˜¤ë„¤ìš” ({weather['temperature']}Â°C). ë¹—ì†Œë¦¬ ë“¤ìœ¼ë©° ë§ˆìŒì„ ì°¨ë¶„íˆ ê°€ë¼ì•‰í˜€ë³´ì„¸ìš” â˜”",
            'ëˆˆ': f"ë§ˆìŒì´ ê²©í•´ì§€ì…¨êµ°ìš”. ëˆˆ ë‚´ë¦¬ëŠ” ê³ ìš”í•¨ ({weather['temperature']}Â°C)ìœ¼ë¡œ ë§ˆìŒì„ ì§„ì •ì‹œì¼œë³´ì„¸ìš” â„ï¸",
            'ì•ˆê°œ': f"ë‹µë‹µí•œ ë§ˆìŒì´ì‹œêµ°ìš” ({weather['temperature']}Â°C). ì•ˆê°œê°€ ê±·íˆë“¯ í™”ë„ ê³§ ê°€ë¼ì•‰ì„ ê±°ì˜ˆìš” ğŸŒ«ï¸"
        },
        'anxious': {
            'ë§‘ìŒ': f"ë¶ˆì•ˆí•˜ì‹œêµ°ìš”. í•˜ì§€ë§Œ ë§‘ì€ í•˜ëŠ˜ ({weather['temperature']}Â°C)ì²˜ëŸ¼ ë§ˆìŒë„ ë§‘ì•„ì§ˆ ê±°ì˜ˆìš”. ì‹¬í˜¸í¡í•˜ë©° ì‚°ì±…í•´ë³´ì„¸ìš” ğŸŒ",
            'íë¦¼': f"ê±±ì •ì´ ë§ìœ¼ì‹œêµ°ìš”. íë¦° ë‚ ì”¨ ({weather['temperature']}Â°C)ì§€ë§Œ ê³§ í•´ê°€ ë‚  ê±°ì˜ˆìš”. ë”°ëœ»í•œ ì°¨ë¡œ ë§ˆìŒì„ ë‹¬ë˜ë³´ì„¸ìš” â˜ï¸",
            'ë¹„': f"ë¶ˆì•ˆí•œ ë§ˆìŒì— ë¹„ê¹Œì§€ ì˜¤ë„¤ìš” ({weather['temperature']}Â°C). ë¹—ì†Œë¦¬ì˜ ë¦¬ë“¬ìœ¼ë¡œ ë§ˆìŒì„ ì§„ì •ì‹œì¼œë³´ì„¸ìš” â˜”",
            'ëˆˆ': f"ê±±ì •ì´ ë§ìœ¼ì‹œêµ°ìš” ({weather['temperature']}Â°C). ëˆˆì†¡ì´ì²˜ëŸ¼ í•˜ë‚˜ì”© ì²œì²œíˆ í•´ê²°í•´ë‚˜ê°€ë©´ ë¼ìš” â„ï¸",
            'ì•ˆê°œ': f"ë§ˆìŒì´ ì•ˆê°œì²˜ëŸ¼ ë¶ˆë¶„ëª…í•˜ì‹œêµ°ìš” ({weather['temperature']}Â°C). ì‹œê°„ì´ ì§€ë‚˜ë©´ ëª¨ë“  ê²Œ ëª…í™•í•´ì§ˆ ê±°ì˜ˆìš” ğŸŒ«ï¸"
        },
        'tired': {
            'ë§‘ìŒ': f"í”¼ê³¤í•˜ì‹œêµ°ìš”. ë§‘ì€ ë‚ ì”¨ ({weather['temperature']}Â°C)ì§€ë§Œ ì˜¤ëŠ˜ì€ í‘¹ ì‰¬ì„¸ìš”. í–‡ë³•ë§Œ ì ê¹ ì¬ì–´ë„ ì¢‹ì•„ìš” ğŸŒ",
            'íë¦¼': f"ì§€ì¹˜ì…¨êµ°ìš”. íë¦° ë‚ ì”¨ ({weather['temperature']}Â°C)ì— ë§ì¶° ì§‘ì—ì„œ í¸ì•ˆíˆ ì‰¬ì„¸ìš” â˜ï¸",
            'ë¹„': f"í”¼ê³¤í•œ ëª¸ì— ë¹„ ì˜¤ëŠ” ë‚  ({weather['temperature']}Â°C). ë¹—ì†Œë¦¬ ë“¤ìœ¼ë©° ê¹Šì€ ì ì— ë¹ ì ¸ë³´ì„¸ìš” â˜”",
            'ëˆˆ': f"ì§€ì¹˜ì…¨êµ°ìš” ({weather['temperature']}Â°C). ëˆˆ ë‚´ë¦¬ëŠ” ê³ ìš”í•œ ë°¤, ë”°ëœ»í•˜ê²Œ íœ´ì‹í•˜ì„¸ìš” â„ï¸",
            'ì•ˆê°œ': f"ëª¸ì´ ë¬´ê±°ìš°ì‹œêµ°ìš” ({weather['temperature']}Â°C). ì•ˆê°œì²˜ëŸ¼ ëª½ë¡±í•œ ê¸°ë¶„, ì¶©ë¶„íˆ ì‰¬ì„¸ìš” ğŸŒ«ï¸"
        },
        'excited': {
            'ë§‘ìŒ': f"ì„¤ë ˆì‹œëŠ”êµ°ìš”! ë§‘ì€ ë‚ ì”¨ ({weather['temperature']}Â°C)ì™€ í•¨ê»˜ ì™„ë²½í•œ í•˜ë£¨ë„¤ìš”! ë­”ê°€ ìƒˆë¡œìš´ ê±¸ ì‹œì‘í•´ë³´ì„¸ìš” ğŸŒ",
            'íë¦¼': f"ê¸°ëŒ€ê°ì´ í¬ì‹œêµ°ìš”! íë¦° ë‚ ì”¨ ({weather['temperature']}Â°C)ì§€ë§Œ ë§ˆìŒì€ í™”ì°½í•˜ì‹œë„¤ìš” â˜ï¸",
            'ë¹„': f"ì„¤ë ˆëŠ” ë§ˆìŒì´ì‹œêµ°ìš”! ë¹„ ì˜¤ëŠ” ë‚  ({weather['temperature']}Â°C)ë„ íŠ¹ë³„í•œ ì¶”ì–µì´ ë  ìˆ˜ ìˆì–´ìš” â˜”",
            'ëˆˆ': f"í¥ë¯¸ì§„ì§„í•˜ì‹œêµ°ìš”! ëˆˆ ë‚´ë¦¬ëŠ” ë‚  ({weather['temperature']}Â°C), ë­”ê°€ ë§ˆë²• ê°™ì€ ì¼ì´ ì¼ì–´ë‚  ê²ƒ ê°™ì•„ìš” â„ï¸",
            'ì•ˆê°œ': f"ê¸°ëŒ€ê°€ í¬ì‹œêµ°ìš” ({weather['temperature']}Â°C)! ì•ˆê°œ ì†ì—ì„œë„ ìƒˆë¡œìš´ ë°œê²¬ì´ ìˆì„ ê±°ì˜ˆìš” ğŸŒ«ï¸"
        },
        'neutral': {
            'ë§‘ìŒ': f"í‰ì˜¨í•œ í•˜ë£¨ì‹œêµ°ìš”. ë§‘ì€ ë‚ ì”¨ ({weather['temperature']}Â°C)ë¥¼ ì¦ê¸°ë©° ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš” ğŸŒ",
            'íë¦¼': f"ì”ì”í•œ ê¸°ë¶„ì´ì‹œêµ°ìš”. íë¦° ë‚ ì”¨ ({weather['temperature']}Â°C)ì— ë§ì¶° ì—¬ìœ ë¡œìš´ ì‹œê°„ ë³´ë‚´ì„¸ìš” â˜ï¸",
            'ë¹„': f"ì°¨ë¶„í•œ ê¸°ë¶„ì´ì‹œêµ°ìš”. ë¹„ ì˜¤ëŠ” ë‚  ({weather['temperature']}Â°C) ì‹¤ë‚´ì—ì„œ í¸ì•ˆí•œ ì‹œê°„ ë³´ë‚´ì„¸ìš” â˜”",
            'ëˆˆ': f"ê³ ìš”í•œ ë§ˆìŒì´ì‹œêµ°ìš”. ëˆˆ ë‚´ë¦¬ëŠ” í‰í™”ë¡œìš´ ë‚  ({weather['temperature']}Â°C) ì¦ê¸°ì„¸ìš” â„ï¸",
            'ì•ˆê°œ': f"ì”ì”í•œ ê¸°ë¶„ì´ì‹œêµ°ìš” ({weather['temperature']}Â°C). ì•ˆê°œ ë‚€ ì‹ ë¹„ë¡œìš´ ë¶„ìœ„ê¸°ë¥¼ ë§Œë½í•´ë³´ì„¸ìš” ğŸŒ«ï¸"
        }
    }
    
    return responses.get(emotion, responses['neutral']).get(weather['condition'], 
           f"ì˜¤ëŠ˜ ë‚ ì”¨ëŠ” {weather['condition']}, ê¸°ì˜¨ì€ {weather['temperature']}Â°Cì…ë‹ˆë‹¤.")

@app.route('/')
def index():
    return render_template('chatbot.html')

@app.route('/chat', methods=['POST'])
def chat():
    try:
        data = request.get_json()
        user_message = data.get('message', '')
        
        if not user_message.strip():
            return jsonify({'error': 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'})
        
        # ê°ì • ë¶„ì„
        emotion = analyze_emotion(user_message)
        
        # ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        weather = get_weather_data()
        
        # ë§ì¶¤í˜• ì‘ë‹µ ìƒì„±
        response = generate_response(emotion, weather)
        
        return jsonify({
            'response': response,
            'emotion': emotion,
            'weather': weather,
            'timestamp': datetime.now().strftime('%H:%M')
        })
        
    except Exception as e:
        return jsonify({'error': f'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'})

if __name__ == '__main__':
    app.run(debug=True, port=5001)